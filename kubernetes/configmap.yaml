# kubernetes/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: vision-config
  namespace: robot-vision
  labels:
    app: vision-inference
    component: config
data:
  # Inference configuration
  inference.yaml: |
    model:
      type: "hybrid_vision"
      checkpoint_path: "/models/vision_model.pt"
      device: "cuda:0"
      precision: "mixed"
      
    inference:
      batch_size: 16
      max_batch_size: 32
      batch_timeout: 0.1
      num_workers: 2
      use_cuda_graph: true
      cuda_streams: 2
      
    preprocessing:
      image_size: [416, 416]
      mean: [0.485, 0.456, 0.406]
      std: [0.229, 0.224, 0.225]
      keep_aspect_ratio: true
      pad_value: 114
      
    postprocessing:
      confidence_threshold: 0.25
      iou_threshold: 0.45
      max_detections: 300
      nms_type: "class_agnostic"
      
    output:
      format: "json"
      include_confidence: true
      include_class_names: true
      include_bounding_boxes: true
      
    monitoring:
      enable_prometheus: true
      metrics_port: 9090
      collect_inference_metrics: true
      collect_memory_metrics: true
      collect_gpu_metrics: true
      
    logging:
      level: "INFO"
      format: "json"
      output: "stdout"
      rotation: "100MB"
      retention: "7d"
  
  # API configuration
  api-config.yaml: |
    server:
      host: "0.0.0.0"
      port: 8000
      workers: 2
      backlog: 2048
      timeout: 30
      
    cors:
      enabled: true
      origins:
        - "*"
      methods:
        - GET
        - POST
        - OPTIONS
      headers:
        - Content-Type
        - Authorization
      
    rate_limit:
      enabled: true
      requests_per_minute: 1000
      burst_size: 100
      
    authentication:
      enabled: false
      jwt_secret: ""
      api_keys: []
      
    endpoints:
      health: "/health"
      ready: "/ready"
      metrics: "/metrics"
      detect: "/v1/detect"
      batch_detect: "/v1/batch_detect"
      streaming: "/v1/streaming"
      
    caching:
      enabled: true
      redis_host: "vision-redis.robot-vision.svc.cluster.local"
      redis_port: 6379
      ttl_seconds: 3600
      
    queue:
      enabled: true
      redis_host: "vision-redis.robot-vision.svc.cluster.local"
      redis_port: 6379
      queue_name: "inference_queue"
      max_retries: 3
  
  # gRPC configuration
  grpc-config.yaml: |
    server:
      host: "0.0.0.0"
      port: 50051
      max_workers: 10
      max_message_length: 10485760  # 10MB
      
    services:
      - name: "VisionService"
        methods:
          - "Detect"
          - "BatchDetect"
          - "StreamDetect"
          - "GetModelInfo"
          
    ssl:
      enabled: false
      cert_path: ""
      key_path: ""
      
    interceptors:
      - name: "logging"
        enabled: true
      - name: "metrics"
        enabled: true
      - name: "recovery"
        enabled: true
  
  # Robot interface configuration
  robot-config.yaml: |
    interfaces:
      ros2:
        enabled: true
        topic: "/vision/detections"
        queue_size: 10
        qos_profile: "sensor_data"
        
      websocket:
        enabled: true
        port: 8765
        path: "/ws"
        ping_interval: 30
        
      mqtt:
        enabled: false
        broker: "mqtt://localhost:1883"
        topic_prefix: "robot/vision/"
        
    camera:
      source_type: "realsense"  # realsense, webcam, ros_topic, file
      width: 640
      height: 480
      fps: 30
      format: "bgr8"
      
    robot_params:
      arm_reach: 1.2  # meters
      gripper_width: 0.1  # meters
      max_object_weight: 2.0  # kg
      safety_distance: 0.5  # meters
      
    control:
      mode: "autonomous"  # autonomous, teleop, semi-autonomous
      response_timeout: 5.0  # seconds
      max_retries: 3
  
  # Logging configuration
  logging.yaml: |
    version: 1
    disable_existing_loggers: false
    
    formatters:
      json:
        class: pythonjsonlogger.jsonlogger.JsonFormatter
        format: "%(asctime)s %(name)s %(levelname)s %(message)s"
      simple:
        format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
        
    handlers:
      console:
        class: logging.StreamHandler
        level: INFO
        formatter: json
        stream: ext://sys.stdout
        
      file:
        class: logging.handlers.RotatingFileHandler
        level: DEBUG
        formatter: json
        filename: /app/logs/vision.log
        maxBytes: 104857600  # 100MB
        backupCount: 5
        
      error_file:
        class: logging.handlers.RotatingFileHandler
        level: ERROR
        formatter: json
        filename: /app/logs/vision_error.log
        maxBytes: 10485760  # 10MB
        backupCount: 5
        
    loggers:
      vision:
        level: INFO
        handlers: [console, file, error_file]
        propagate: false
        
      grpc:
        level: WARNING
        handlers: [console]
        propagate: false
        
    root:
      level: INFO
      handlers: [console]